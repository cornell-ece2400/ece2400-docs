



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Christopher Batten">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>Ece2400 sec5 c profiling - ECE 2400 Section Handouts</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.077507d7.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.ff0a5ce4.min.css">
      
      
        
        
        <meta name="theme-color" content="#2094f3">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#section-5-c-profiling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="ECE 2400 Section Handouts" class="md-header-nav__button md-logo" aria-label="ECE 2400 Section Handouts">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            ECE 2400 Section Handouts
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Ece2400 sec5 c profiling
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/cornell-ece2400/ece2400-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece2400/ece2400-docs
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ECE 2400 Section Handouts" class="md-nav__button md-logo" aria-label="ECE 2400 Section Handouts">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ECE 2400 Section Handouts
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cornell-ece2400/ece2400-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece2400/ece2400-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec1-linux/" title="Section 1: Linux Development Environment" class="md-nav__link">
      Section 1: Linux Development Environment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec2-c-basics/" title="Section 2: Compiling and Running C Programs" class="md-nav__link">
      Section 2: Compiling and Running C Programs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec3-c-build-test/" title="Section 3: C Build and Test Frameworks" class="md-nav__link">
      Section 3: C Build and Test Frameworks
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-the-ecelinux-machines" class="md-nav__link">
    1. The ecelinux Machines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-warmup-implement-array-average-functions" class="md-nav__link">
    2. Warmup: Implement Array Average Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-measuring-execution-time" class="md-nav__link">
    3. Measuring Execution Time
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-profiling-execution-time" class="md-nav__link">
    4. Profiling Execution Time
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-profiling-memory-usage" class="md-nav__link">
    5. Profiling Memory Usage
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cornell-ece2400/ece2400-docs/edit/master/docs/ece2400-sec5-c-profiling.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="section-5-c-profiling">Section 5: C Profiling<a class="headerlink" href="#section-5-c-profiling" title="Permanent link">&para;</a></h1>
<p>In this discussion, we will explore how to measure the performance of a C
evaluation program and deal with dynamic memory issues.</p>
<h2 id="1-the-ecelinux-machines">1. The ecelinux Machines<a class="headerlink" href="#1-the-ecelinux-machines" title="Permanent link">&para;</a></h2>
<p>Follow the same process as in the last section.</p>
<ul>
<li>login to a workstation with your NetID and password</li>
<li>use MobaXterm to log into the <code>ecelinux</code> servers</li>
<li>make sure you source the setup script</li>
<li>verify ECE2400 is in your prompt</li>
</ul>
<p>Now clone the GitHub repo we will be using in this section using the
following commands:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">source</span> setup-ece2400.sh
% mkdir -p <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400
% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400
% git clone git@github.com:cornell-ece2400/ece2400-sec5 sec5
% <span class="nb">cd</span> sec5
% tree
</code></pre></div>
</td></tr></table>

<p>The repository includes the following files:</p>
<ul>
<li><code>stack-array-eval.c</code>: source and main for using an array of elements on stack</li>
<li><code>heap-array-eval.c</code>: source and main for using an array of elements on heap</li>
</ul>
<h2 id="2-warmup-implement-array-average-functions">2. Warmup: Implement Array Average Functions<a class="headerlink" href="#2-warmup-implement-array-average-functions" title="Permanent link">&para;</a></h2>
<p>Take a look at the <code>stack-array-eval.c</code> source file. You will see four
functions:</p>
<ul>
<li><code>init_array</code> : initialize an array of integers with random values</li>
<li><code>avg_array</code> : find average of an array of integers</li>
<li><code>init_parray</code> : initialize an array of pointers to integers</li>
<li><code>avg_parray</code> : find average of an array of pointers to integers</li>
</ul>
<p>The first two functions operate on an array of integers, while the second
two functions operate on an array of <em>pointers</em> to integers. Start by
sketching a state diagram for the given main program assuming <code>size</code> is
set to 3. Work through the state diagram and stop when you get to the
call to the <code>avg_array</code> function. Use this state diagram to understand
the difference between the array of integers vs. the array of pointers to
integers.</p>
<p>Now implement the <code>avg_array</code> function which should find the average of
the integers stored in the given array. Then implement the <code>avg_parray</code>
function which should find the average of the integers <em>pointed to</em> by
the given array. Compile and execute your program a couple of times,
changing the seed passed into <code>srand</code> each time. Verify that the value
returned by <code>avg_array</code> always equals the value returned by <code>avg_parray</code>
and that the average is always around 500.</p>
<h2 id="3-measuring-execution-time">3. Measuring Execution Time<a class="headerlink" href="#3-measuring-execution-time" title="Permanent link">&para;</a></h2>
<p>Now assume we want to quantitatively measure how long it takes to
initialize both arrays and then calculate the averages. To do this, we
can use the time functions provided by the C standard library in the
<code>sys/time.h</code> header file. Go ahead and add the following header to your
evaluation program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>
</code></pre></div>
</td></tr></table>

<p>We can use the <code>gettimeofday</code> function to get the current time:</p>
<ul>
<li><a href="http://man7.org/linux/man-pages/man2/gettimeofday.2.html">http://man7.org/linux/man-pages/man2/gettimeofday.2.html</a></li>
</ul>
<p>This function takes as a parameter a pointer to a struct of type <code>struct
timeval</code>. It uses call-by-pointer semantics to update this struct with
the current time with a precision of 10s of microseconds. The struct has
two fields: <code>tv_sec</code> is the number of seconds and <code>tv_usec</code> is the number
of microseconds since January 1, 1970. We can use <code>gettimeofday</code> like
this to quantitatively measure how long it takes to run an experiment.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c1">// Track time using timers</span>

<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">start</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">end</span><span class="p">;</span>

<span class="c1">// Start tracking time</span>

<span class="n">gettimeofday</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>

<span class="c1">// Run the experiment</span>

<span class="c1">// ...</span>

<span class="c1">// Stop tracking time</span>

<span class="n">gettimeofday</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>

<span class="c1">// Calculate elapsed time</span>

<span class="kt">double</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span> <span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span> <span class="p">)</span> <span class="o">+</span>
               <span class="p">(</span> <span class="p">(</span> <span class="n">end</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">start</span><span class="p">.</span><span class="n">tv_usec</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span> <span class="p">);</span>

<span class="n">printf</span><span class="p">(</span> <span class="s">&quot;Elapsed time for trial is %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">elapsed</span> <span class="p">);</span>
</code></pre></div>
</td></tr></table>

<p>Modify the <code>stack-array-eval.c</code> program to measure how long one
experiment takes, compile the program with optimizations, and then run
the experiment.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% gcc -Wall -o stack-array-eval stack-array-eval.c
% ./stack-array-eval
</code></pre></div>
</td></tr></table>

<p>You will notice that the execution time is very short ... so short that
it is too fast for the resolution of the timer. We need to run a subtrial
in a loop many times to make sure we have a long enough experiment that
we can get a reasonable accurate time measurement. Put the subtrial in a
loop like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

  <span class="kt">int</span> <span class="n">array</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="n">init_array</span><span class="p">(</span> <span class="n">array</span><span class="p">,</span> <span class="n">size</span> <span class="p">);</span>

  <span class="kt">int</span><span class="o">*</span> <span class="n">parray</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="n">init_parray</span><span class="p">(</span> <span class="n">parray</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">size</span> <span class="p">);</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">avg_array</span><span class="p">(</span> <span class="n">array</span><span class="p">,</span> <span class="n">size</span> <span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">avg_parray</span><span class="p">(</span> <span class="n">parray</span><span class="p">,</span> <span class="n">size</span> <span class="p">);</span>

<span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>Your program should now run for a couple of seconds and this should
enable a much more precise time measurement. Try running the program at
least five times and write down the results for each trial. Is the
execution time always the same? If not, why not?</p>
<p>We need to do several trials and then take the average execution time to
ensure we can get a good estimate of the execution time. Restructure your
evaluation program to look like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nb">int</span> <span class="n">main</span><span class="p">(</span> <span class="n">void</span><span class="p">)</span>
<span class="err">{</span>
  <span class="nb">int</span> <span class="n">ntrials</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">nsubtrials</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e5</span><span class="p">;</span>

  <span class="n">double</span> <span class="n">elapsed_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span> <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntrials</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="err">{</span>

    <span class="o">//</span> <span class="n">Track</span> <span class="k">time</span> <span class="k">using</span> <span class="n">timers</span>

    <span class="n">struct</span> <span class="n">timeval</span> <span class="k">start</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">timeval</span> <span class="k">end</span><span class="p">;</span>

    <span class="o">//</span> <span class="k">Start</span> <span class="n">tracking</span> <span class="k">time</span>

    <span class="n">gettimeofday</span><span class="p">(</span> <span class="o">&amp;</span><span class="k">start</span><span class="p">,</span> <span class="k">NULL</span> <span class="p">);</span>

    <span class="o">//</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">experiment</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nsubtrials</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="err">{</span>

      <span class="o">//</span> <span class="p">...</span> <span class="n">run</span> <span class="n">one</span> <span class="n">trial</span> <span class="p">...</span>

    <span class="err">}</span>

    <span class="o">//</span> <span class="n">Stop</span> <span class="n">tracking</span> <span class="k">time</span>

    <span class="n">gettimeofday</span><span class="p">(</span> <span class="o">&amp;</span><span class="k">end</span><span class="p">,</span> <span class="k">NULL</span> <span class="p">);</span>

    <span class="o">//</span> <span class="n">Calculate</span> <span class="n">elapsed</span> <span class="k">time</span>

    <span class="n">double</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span> <span class="k">end</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="k">start</span><span class="p">.</span><span class="n">tv_sec</span> <span class="p">)</span> <span class="o">+</span>
                   <span class="p">(</span> <span class="p">(</span> <span class="k">end</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="k">start</span><span class="p">.</span><span class="n">tv_usec</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">.</span><span class="mi">0</span> <span class="p">);</span>

    <span class="n">elapsed_avg</span> <span class="o">+=</span> <span class="n">elapsed</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span> <span class="ss">&quot;Elapsed time for trial %d is %f\n&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">elapsed</span> <span class="p">);</span>
  <span class="err">}</span>

  <span class="o">//</span> <span class="n">Calculate</span> <span class="n">average</span> <span class="n">elapsed</span> <span class="k">time</span> <span class="n">per</span> <span class="n">trial</span>

  <span class="n">elapsed_avg</span> <span class="o">=</span> <span class="n">elapsed_avg</span> <span class="o">/</span> <span class="n">ntrials</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span> <span class="ss">&quot;Elapsed time (averaged) is %f\n&quot;</span><span class="p">,</span> <span class="n">elapsed_avg</span> <span class="p">);</span>
<span class="err">}</span>
</code></pre></div>
</td></tr></table>

<p>Now use your evaluation program to quantitatively measure the execution
time of this experiment.</p>
<div class="admonition note">
<p class="admonition-title">To-Do On Your Own</p>
<p>Experiment with turning optimizations on with the <code>-O3</code> command line
option. Compare the performance of this experiment with and without
optimizations.</p>
</div>
<h2 id="4-profiling-execution-time">4. Profiling Execution Time<a class="headerlink" href="#4-profiling-execution-time" title="Permanent link">&para;</a></h2>
<p>The previous section enables us to measure the overall execution time,
but we might also be interested to know which functions are taking the
most time. This can help us focus on the important hotspots for
optimization. We can use <em>profiling</em> to do this kind of performance
analysis. We will be using the <code>perf</code> tool to do this kind of profiling.
It is important to turn debugging on when doing profiling so we can track
the function call stacks. Combining the debugging (<code>-g</code>) with
optimizations (<code>-O3</code>) will not slow down your program, but may
occassionally produce some confusing situations when debugging or
profiling since some of the original program might have been optimized
away.</p>
<p>Let's start by recompiling our program with support for debugging:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% gcc -Wall -g -o stack-array-eval stack-array-eval.c
</code></pre></div>
</td></tr></table>

<p>We can now use <code>perf</code> to profile our program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% perf record --call-graph dwarf ./stack-array-eval
</code></pre></div>
</td></tr></table>

<p><code>perf</code> works by interrupts your program several times throughout the
execution to take a "sample". During each sample, <code>perf</code> will stop your
program and examine the stack to see the list of function stack frames
that are currently allocated on the stack. <code>perf</code> will keep counters of
every call stack it sees. After <code>perf</code> is done it will output the total
number samples. If this number is too small then the profiling
information may not be very accurate. We can display this information
like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% perf script report stackcollapse
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main <span class="m">78</span>
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main<span class="p">;</span>init_array <span class="m">8731</span>
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main<span class="p">;</span>init_array<span class="p">;</span>rand <span class="m">1416</span>
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main<span class="p">;</span>init_array<span class="p">;</span>rand<span class="p">;</span>__random <span class="m">4239</span>
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main<span class="p">;</span>init_array<span class="p">;</span>rand<span class="p">;</span>__random<span class="p">;</span>__random_r <span class="m">6959</span>
stack-array-eval<span class="p">;</span>_start<span class="p">;</span>__libc_start_main<span class="p">;</span>main<span class="p">;</span>init_array<span class="p">;</span>rand@plt <span class="m">4</span>
stack-array-eval<span class="p">;</span>main <span class="m">6</span>
stack-array-eval<span class="p">;</span>main<span class="p">;</span>avg_array <span class="m">6025</span>
stack-array-eval<span class="p">;</span>main<span class="p">;</span>avg_parray <span class="m">5230</span>
stack-array-eval<span class="p">;</span>main<span class="p">;</span>init_parray <span class="m">6693</span>
</code></pre></div>
</td></tr></table>

<p>There is one line for every unique call stack which was sampled. The line
shows the name of the call stack and how many of the samples were taken
with that call stack. In the above example, 8731 samples where taken with
the call stack: <code>main</code> calling <code>init_array</code>. <code>perf</code> can also provide a
more interactive view to explore this profile information.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% perf report
</code></pre></div>
</td></tr></table>

<p>The report shows a line for various functions that consumed a significant
amount of the execution time. The <em>Childen</em> column is the total time
consumed in that function <em>including</em> any time spent in that function's
children. The <em>Self</em> column is the time spent just in that function
<em>excluding</em> any time spent in that function's children. The percentages
are all a percentage of the total execution time. You can use the arrow
keys to slect a function and you can press enter to show what functions
called this function and to see more about the children of this function.</p>
<p>You can also generate a flame graph, which is a very useful way to
interactively visualize this profiling information:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% perf script report stackcollapse <span class="p">|</span> flamegraph.pl &gt; graph.svg
% firefox graph.svg
</code></pre></div>
</td></tr></table>

<p>In a flame graph the x-axis shows the stack profile population, sorted
alphabetically and the y-axis shows the stack depth counting form zero at
the bottom. Each rectangle represents a stack frame. The wider a frame is
is, the more often it was present in the stacks. The top edge shows what
function was executing when the sample was taken, and beneath it is its
ancestry. The colors are usually not significant, picked randomly to
differentiate frames. See this great article for more on flame graphs:</p>
<ul>
<li><a href="https://queue.acm.org/detail.cfm?id=2927301">https://queue.acm.org/detail.cfm?id=2927301</a></li>
</ul>
<div class="admonition note">
<p class="admonition-title">To-Do On Your Own</p>
<p>Experiment with turning optimizations on with the <code>-O3</code> command line
option. Compare the profiling data for this experiment with and
without optimizations.</p>
</div>
<h2 id="5-profiling-memory-usage">5. Profiling Memory Usage<a class="headerlink" href="#5-profiling-memory-usage" title="Permanent link">&para;</a></h2>
<p>The previous sections focused on performance, but we also care about
memory usage. Valgrind is a tool specifically designed for memory
debugging, memory leak detection, and memory profiling. Take a look at
the <code>heap-array-eval.c</code> file. Compile and run this file to test its
performance. Unfortunately, this program has a memory leak since the
arrays are allocated on the heap by never deallocated. We can use
valgrind to detect this leak:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>% <span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece2400/sec5
% gcc -Wall -o heap-array-eval heap-array-eval.c
% ./heap-array-eval
% valgrind --leak-check<span class="o">=</span>yes ./heap-array-eval
</code></pre></div>
</td></tr></table>

<p>Unfortuntaely, Valgrind can slow your program down by a factor of 10x. So
to speed things up, change the <code>nsubtrials</code> to be 1. Valgrind will report
the memory leak and even identify the line in the code which allocated
the variables which were then never deallocated. Add an approriate call
to <code>free</code> to fix the memory leak, and then rerun Valgrind to verify that
the problem has been fixed.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Christopher Batten
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/extras.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>