



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Christopher Batten">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>Ece2400 memory debugging - ECE 2400 Section Handouts</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.077507d7.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.ff0a5ce4.min.css">
      
      
        
        
        <meta name="theme-color" content="#2094f3">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-debug-memory-problems" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="ECE 2400 Section Handouts" class="md-header-nav__button md-logo" aria-label="ECE 2400 Section Handouts">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            ECE 2400 Section Handouts
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Ece2400 memory debugging
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/cornell-ece2400/ece2400-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece2400/ece2400-docs
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ECE 2400 Section Handouts" class="md-nav__button md-logo" aria-label="ECE 2400 Section Handouts">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ECE 2400 Section Handouts
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cornell-ece2400/ece2400-docs/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece2400/ece2400-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec1-linux/" title="Section 1: Linux Development Environment" class="md-nav__link">
      Section 1: Linux Development Environment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec2-c-basics/" title="Section 2: Compiling and Running C Programs" class="md-nav__link">
      Section 2: Compiling and Running C Programs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ece2400-sec3-c-build-test/" title="Section 3: C Build and Test Frameworks" class="md-nav__link">
      Section 3: C Build and Test Frameworks
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-memory-leak" class="md-nav__link">
    1. Memory leak
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-double-free-your-memory" class="md-nav__link">
    2. Double free your memory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-invalid-memory-access" class="md-nav__link">
    3. Invalid memory access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-valgrind-in-your-pas" class="md-nav__link">
    How to use valgrind in your PAs
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cornell-ece2400/ece2400-docs/edit/master/docs/ece2400-memory-debugging.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="how-to-debug-memory-problems">How to debug memory problems?<a class="headerlink" href="#how-to-debug-memory-problems" title="Permanent link">&para;</a></h1>
<p>Author: Tuan Ta<br />
Date  : Sep 26, 2018</p>
<p>While dynamic memory allocation gives us a lot of freedom in keeping some blocks
of memory alive across function calls, misusing dynamically allocated memory is
often the most common cause of memory corruptions (e.g., segmentation fault). In
this tutorial, I'll walk you through some common mistakes in using dynamic
memory allocation and pointer. For each mistake, I'll show you how to detect it
using a powerful memory checking tool called <em>valgrind</em>.</p>
<h2 id="1-memory-leak">1. Memory leak<a class="headerlink" href="#1-memory-leak" title="Permanent link">&para;</a></h2>
<p>Let's consider this program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code> <span class="mi">1</span> <span class="c1">#include &lt;stdlib.h&gt;</span>
 <span class="mi">2</span> <span class="c1">#include &lt;stdio.h&gt;</span>
 <span class="mi">3</span>
 <span class="mi">4</span> <span class="nb nb-Type">int</span> <span class="n">main</span><span class="p">(</span> <span class="n">void</span> <span class="p">)</span> <span class="p">{</span>
 <span class="mi">5</span>
 <span class="mi">6</span>   <span class="o">//</span> <span class="n">Allocate</span> <span class="n">an</span> <span class="nb nb-Type">int</span> <span class="n">on</span> <span class="n">the</span> <span class="n">heap</span>
 <span class="mi">7</span>   <span class="nb nb-Type">int</span><span class="o">*</span> <span class="n">mem_ptr</span> <span class="o">=</span> <span class="p">(</span> <span class="nb nb-Type">int</span><span class="o">*</span> <span class="p">)</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">sizeof</span><span class="p">(</span> <span class="nb nb-Type">int</span><span class="p">)</span> <span class="p">);</span>
 <span class="mi">8</span>
 <span class="mi">9</span>   <span class="o">//</span> <span class="n">Initialize</span> <span class="n">that</span> <span class="nb nb-Type">int</span> <span class="n">variable</span>
<span class="mi">10</span>   <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="mi">11</span>
<span class="mi">12</span>   <span class="n">printf</span><span class="p">(</span><span class="s2">&quot; Before: mem_ptr: address = </span><span class="si">%lx</span><span class="s2">, value = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="mi">13</span>
<span class="mi">14</span>   <span class="o">//</span> <span class="n">Declare</span> <span class="n">a</span> <span class="n">new</span> <span class="nb nb-Type">int</span> <span class="n">variable</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
<span class="mi">15</span>   <span class="nb nb-Type">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="mi">16</span>
<span class="mi">17</span>   <span class="o">//</span> <span class="n">Reuse</span> <span class="n">mem_ptr</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="s2">&quot;a&quot;</span>
<span class="mi">18</span>   <span class="n">mem_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
<span class="mi">19</span>
<span class="mi">20</span>   <span class="n">printf</span><span class="p">(</span><span class="s2">&quot; After: mem_ptr: address = </span><span class="si">%lx</span><span class="s2">, value = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="mi">21</span>
<span class="mi">22</span>   <span class="o">//</span> <span class="n">How</span> <span class="n">do</span> <span class="n">I</span> <span class="n">get</span> <span class="n">back</span> <span class="n">my</span> <span class="n">memory</span> <span class="n">on</span> <span class="n">the</span> <span class="n">heap</span><span class="err">?</span>
<span class="mi">23</span>
<span class="mi">24</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">25</span> <span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>We first allocate a block of memory on the heap (in line 7). Then, we assign
mem_ptr to point to a different block of memory on the stack (in line 18). By
assigning "mem_ptr" to a different block of memory, we lose the only way to go
back to our heap memory block. Therefore, in line 22, we cannot free that heap
memory block.</p>
<p>There're actually two problems here:</p>
<ul>
<li>
<p>First, since there is no pointer pointing to the block of memory on the heap,
that block of memory becomes "orphan".</p>
</li>
<li>
<p>Second, since we do not or cannot free the block of memory, we lose it in our
program. This problem is called "memory leak".</p>
</li>
</ul>
<p>Now, let's compile and run the program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">ECE2400: ~/ece2400/tests % gcc -Wall -g -O3 -o mem-leak mem-leak.c</span>
<span class="c">ECE2400: ~/ece2400/tests % ./mem-leak</span>
<span class="c"> Before: mem_ptr: address = 0x1a17010, value = 10</span>
<span class="c"> After: mem_ptr: address = 0x7fffabe3582c, value = 20</span>
</code></pre></div>
</td></tr></table>

<p>Notice that there is no compilation error! And our program runs "completely
fine", or does it?</p>
<p>Well, if your memory leak is small enough (e.g., in this program, we lose only 4
bytes of memory), then your program may not crash. Think about if your memory
leak accumulates over time in a long program, then something nasty (e.g.,
segmentation fault) will happen! We don't want that.</p>
<p>So how to detect memory leak. Luckily, we have a powerful tool called "Valgrind"
to help us. Let's use the tool to run our buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">ECE2400: ~/ece2400/tests % valgrind --leak-check=full --error-exitcode=1 ./mem-leak</span>
<span class="err">==14973== Memcheck, a memory error detector</span>
<span class="err">==14973== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.</span>
<span class="err">==14973== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info</span>
<span class="err">==14973== Command: ./mem-leak</span>
<span class="err">==14973==</span>
<span class="err"> Before: mem_ptr: address = 0x5202040, value = 10</span>
<span class="err"> After: mem_ptr: address = 0xffefff4dc, value = 20</span>
<span class="err">==14973==</span>
<span class="err">==14973== HEAP SUMMARY:</span>
<span class="err">==14973==     in use at exit: 4 bytes in 1 blocks</span>
<span class="err">==14973==   total heap usage: 1 allocs, 0 frees, 4 bytes allocated</span>
<span class="err">==14973==</span>
<span class="err">==14973== 4 bytes in 1 blocks are definitely lost in loss record 1 of 1</span>
<span class="err">==14973==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)</span>
<span class="err">==14973==    by 0x40047D: main (mem-leak.c:7)</span>
<span class="err">==14973==</span>
<span class="err">==14973== LEAK SUMMARY:</span>
<span class="err">==14973==    definitely lost: 4 bytes in 1 blocks</span>
<span class="err">==14973==    indirectly lost: 0 bytes in 0 blocks</span>
<span class="err">==14973==      possibly lost: 0 bytes in 0 blocks</span>
<span class="err">==14973==    still reachable: 0 bytes in 0 blocks</span>
<span class="err">==14973==         suppressed: 0 bytes in 0 blocks</span>
<span class="err">==14973==</span>
<span class="err">==14973== For counts of detected and suppressed errors, rerun with: -v</span>
<span class="err">==14973== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span>
</code></pre></div>
</td></tr></table>

<p>Here I run <em>valgrind</em> with two options <em>--leak-check=full</em> that tells <em>valgrind</em>
to give details about any possible memory leak in our program and
<em>--error-exitcode=1</em> that tells <em>valgrind</em> to return an error code of 1 if any
memory error is detected.</p>
<p>Let's dive into what <em>valgrind</em> is telling us here. We thought our program ran
fine, but Valgrind reported that we "definitely lost" 4 bytes of memory on the
heap and that no memory block on the heap was "still reachable" at the end of
the program. The report tells us exactly what we expect in the buggy program
right? Our heap memory block has no pointer pointing to it at the end of the
program, so it is not reachable. Since there is no way to reach to the block, we
could not free that block. Therefore, that block of heap memory is definitely
lost.</p>
<p>When you compile your program with <em>-g</em> option, <em>valgrind</em> can tell you where
the leak exactly is in our program. In this case, we lost 4 bytes that were
allocated in line 7 of <em>mem-leak.c</em>.</p>
<p>Let's try to fix the memory bug and re-run <em>valgrind</em> on your own to verify the
leak is actually fixed.</p>
<h2 id="2-double-free-your-memory">2. Double free your memory<a class="headerlink" href="#2-double-free-your-memory" title="Permanent link">&para;</a></h2>
<p>Another common problem is that a block of memory on the heap can be freed twice.
Let's look at this buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code> <span class="mi">1</span> <span class="c1">#include &lt;stdlib.h&gt;</span>
 <span class="mi">2</span> <span class="c1">#include &lt;stdio.h&gt;</span>
 <span class="mi">3</span>
 <span class="mi">4</span> <span class="n">void</span> <span class="n">foo</span><span class="p">(</span> <span class="nb nb-Type">int</span><span class="o">*</span> <span class="n">mem_ptr</span> <span class="p">)</span> <span class="p">{</span>
 <span class="mi">5</span>   <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;In foo(): mem_ptr: address = %p, value = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
 <span class="mi">6</span>   <span class="n">free</span><span class="p">(</span> <span class="n">mem_ptr</span> <span class="p">);</span>
 <span class="mi">7</span> <span class="p">}</span>
 <span class="mi">8</span>
 <span class="mi">9</span> <span class="nb nb-Type">int</span> <span class="n">main</span><span class="p">(</span> <span class="n">void</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">10</span>
<span class="mi">11</span>   <span class="o">//</span> <span class="n">Allocate</span> <span class="n">an</span> <span class="nb nb-Type">int</span> <span class="n">on</span> <span class="n">the</span> <span class="n">heap</span>
<span class="mi">12</span>   <span class="nb nb-Type">int</span><span class="o">*</span> <span class="n">mem_ptr</span> <span class="o">=</span> <span class="p">(</span> <span class="nb nb-Type">int</span><span class="o">*</span> <span class="p">)</span> <span class="n">malloc</span><span class="p">(</span> <span class="n">sizeof</span><span class="p">(</span> <span class="nb nb-Type">int</span><span class="p">)</span> <span class="p">);</span>
<span class="mi">13</span>
<span class="mi">14</span>   <span class="o">//</span> <span class="n">Initialize</span> <span class="n">that</span> <span class="nb nb-Type">int</span> <span class="n">variable</span>
<span class="mi">15</span>   <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="mi">16</span>
<span class="mi">17</span>   <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;In main(): mem_ptr: address = %p, value = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="mi">18</span>
<span class="mi">19</span>   <span class="o">//</span> <span class="n">Call</span> <span class="n">foo</span>
<span class="mi">20</span>   <span class="n">foo</span><span class="p">(</span> <span class="n">mem_ptr</span> <span class="p">);</span>
<span class="mi">21</span>
<span class="mi">22</span>   <span class="o">//</span> <span class="n">Did</span> <span class="n">foo</span> <span class="n">free</span> <span class="n">mem_ptr</span><span class="err">?</span> <span class="n">Maybe</span> <span class="ow">not</span><span class="p">,</span> <span class="n">so</span> <span class="n">let</span><span class="s1">&#39;s just free it here just in case!</span>
<span class="mi">23</span>   <span class="n">free</span><span class="p">(</span> <span class="n">mem_ptr</span> <span class="p">);</span>
<span class="mi">24</span>
<span class="mi">25</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">26</span> <span class="p">}</span>
</code></pre></div>
</td></tr></table>

<p>In line 12, we allocate a block of memory on the heap. In line 20, we pass
"mem_ptr" to <em>foo()</em>. In line 6, <em>foo()</em> after printing the value pointed by
"mem_ptr" frees the block. In line 23, <em>main()</em> tries to re-free "mem_ptr". You
may think that in this small program, it's easy to see that "mem_ptr" is freed
twice, right? In reality, it may be really hard to see this problem especially
when multiple pointers point to the same block of memory (i.e., this is called
pointer aliasing).</p>
<p>Let's run the program and see what will happen:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nl">ECE2400</span><span class="p">:</span><span class="w"> </span><span class="o">~/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">Wall</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O3</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="w"> </span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="nl">ECE2400</span><span class="p">:</span><span class="w"> </span><span class="o">~/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="w"></span>
<span class="ow">In</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="nl">mem_ptr</span><span class="p">:</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xcec010</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="ow">In</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="nl">mem_ptr</span><span class="p">:</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xcec010</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="o">***</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="err">&#39;:</span><span class="w"> </span><span class="k">double</span><span class="w"> </span><span class="k">free</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">corruption</span><span class="w"> </span><span class="p">(</span><span class="n">fasttop</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="mh">0x0000000000cec010</span><span class="w"> </span><span class="o">***</span><span class="w"></span>
<span class="o">=======</span><span class="w"> </span><span class="nl">Backtrace</span><span class="p">:</span><span class="w"> </span><span class="o">=========</span><span class="w"></span>
<span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="mf">.6</span><span class="p">(</span><span class="o">+</span><span class="mh">0x81429</span><span class="p">)</span><span class="o">[</span><span class="n">0x7f5564d81429</span><span class="o">]</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="o">[</span><span class="n">0x4004f8</span><span class="o">]</span><span class="w"></span>
<span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="mf">.6</span><span class="p">(</span><span class="n">__libc_start_main</span><span class="o">+</span><span class="mh">0xf5</span><span class="p">)</span><span class="o">[</span><span class="n">0x7f5564d223d5</span><span class="o">]</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="o">[</span><span class="n">0x400525</span><span class="o">]</span><span class="w"></span>
<span class="o">=======</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="k">map</span><span class="err">:</span><span class="w"> </span><span class="o">========</span><span class="w"></span>
<span class="mi">00400000</span><span class="o">-</span><span class="mi">00401000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587185</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="w"></span>
<span class="mi">00600000</span><span class="o">-</span><span class="mi">00601000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587185</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="w"></span>
<span class="mi">00601000</span><span class="o">-</span><span class="mi">00602000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00001000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587185</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">double</span><span class="o">-</span><span class="k">free</span><span class="w"></span>
<span class="mi">00</span><span class="n">cec000</span><span class="o">-</span><span class="mi">00</span><span class="n">d0d000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                                  </span><span class="o">[</span><span class="n">heap</span><span class="o">]</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5560000000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5560021000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5560021000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564000000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564aea000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564aff000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564aff000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564cfe000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">00015000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564cfe000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564cff000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00014000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564cff000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564d00000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00015000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564d00000</span><span class="o">-</span><span class="mi">7</span><span class="n">f5564ec3000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f5564ec3000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55650c2000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c3000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55650c2000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55650c6000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c2000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55650c6000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55650c8000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c6000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55650c8000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55650cd000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55650cd000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55650ef000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55652c6000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55652c9000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55652eb000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55652ee000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55652ee000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55652ef000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00021000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55652ef000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55652f0000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00022000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">f55652f0000</span><span class="o">-</span><span class="mi">7</span><span class="n">f55652f1000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffeec44c000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffeec46e000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">stack</span><span class="o">]</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffeec485000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffeec487000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">vdso</span><span class="o">]</span><span class="w"></span>
<span class="n">ffffffffff600000</span><span class="o">-</span><span class="n">ffffffffff601000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="o">[</span><span class="n">vsyscall</span><span class="o">]</span><span class="w"></span>
<span class="n">Aborted</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Oopps, our program crashed! No worries. Our friend <em>valgrind</em> can help us detect what went wrong. Let's run <em>valgrind</em> and see what it reports.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">ECE2400: ~/ece2400/tests % valgrind --leak-check=full --error-exitcode=1 ./double-free</span>
<span class="err">==23220== Memcheck, a memory error detector</span>
<span class="err">==23220== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.</span>
<span class="err">==23220== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info</span>
<span class="err">==23220== Command: ./double-free</span>
<span class="err">==23220==</span>
<span class="err">In main(): mem_ptr: address = 0x5202040, value = 10</span>
<span class="err">In foo(): mem_ptr: address = 0x5202040, value = 10</span>
<span class="err">==23220== Invalid free() / delete / delete[] / realloc()</span>
<span class="err">==23220==    at 0x4C2AC7D: free (vg_replace_malloc.c:530)</span>
<span class="err">==23220==    by 0x4004F7: main (double-free.c:23)</span>
<span class="err">==23220==  Address 0x5202040 is 0 bytes inside a block of size 4 free&#39;d</span>
<span class="err">==23220==    at 0x4C2AC7D: free (vg_replace_malloc.c:530)</span>
<span class="err">==23220==    by 0x4004EF: main (double-free.c:20)</span>
<span class="err">==23220==  Block was alloc&#39;d at</span>
<span class="err">==23220==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)</span>
<span class="err">==23220==    by 0x4004CA: main (double-free.c:12)</span>
<span class="err">==23220==</span>
<span class="err">==23220==</span>
<span class="err">==23220== HEAP SUMMARY:</span>
<span class="err">==23220==     in use at exit: 0 bytes in 0 blocks</span>
<span class="err">==23220==   total heap usage: 1 allocs, 2 frees, 4 bytes allocated</span>
<span class="err">==23220==</span>
<span class="err">==23220== All heap blocks were freed -- no leaks are possible</span>
<span class="err">==23220==</span>
<span class="err">==23220== For counts of detected and suppressed errors, rerun with: -v</span>
<span class="err">==23220== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span>
</code></pre></div>
</td></tr></table>

<p>Valgrind tells us that there was an "invalid free()" in line 23 of
<em>double-free.c</em>. Thanks to Valgrind, now you know exactly what the problem is.
Can you fix it on your own and re-run valgrind?</p>
<h2 id="3-invalid-memory-access">3. Invalid memory access<a class="headerlink" href="#3-invalid-memory-access" title="Permanent link">&para;</a></h2>
<p>Remember that C compiler does not check out-of-bounds array access. You may
accidentally access some memory blocks that are not allocated. Let's consider
this buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>
<span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w"></span>
<span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="w"> </span><span class="mi">6</span><span class="w">   </span><span class="n">const</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="mi">7</span><span class="w">   </span><span class="nc">int</span><span class="o">*</span><span class="w"> </span><span class="n">mem_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nc">int</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="w"> </span><span class="n">sizeof</span><span class="p">(</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w"> </span><span class="mi">9</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="mi">10</span><span class="w">     </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="ss">&quot;Initializing mem_ptr[%d] ... \n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="mi">11</span><span class="w">     </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="mi">12</span><span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="mi">13</span><span class="w"></span>
<span class="mi">14</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Print</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">array</span><span class="w"></span>
<span class="mi">15</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="mi">16</span><span class="w">     </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="ss">&quot;mem_ptr[%d] = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="mi">17</span><span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="mi">18</span><span class="w"></span>
<span class="mi">19</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="k">Free</span><span class="w"> </span><span class="n">mem_ptr</span><span class="w"></span>
<span class="mi">20</span><span class="w">   </span><span class="k">free</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span><span class="w"></span>
<span class="mi">21</span><span class="w"></span>
<span class="mi">22</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="mi">23</span><span class="w"> </span><span class="err">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Notice that the program allocates an array of 10 "int" elements on the heap (in
line 7). It by mistake initializes the 11th element when <em>i == size</em> in line 9.
Then in line 15, the program tries to read that unallocated element. When you compile and run the program, you will get something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nl">ECE2400</span><span class="p">:</span><span class="w"> </span><span class="o">~/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">Wall</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O3</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="w"> </span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="nl">ECE2400</span><span class="p">:</span><span class="w"> </span><span class="o">~/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">3</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">5</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">6</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">7</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">8</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">9</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">Initializing</span><span class="w"> </span><span class="n">mem_ptr</span><span class="o">[</span><span class="n">10</span><span class="o">]</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">4</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">5</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">6</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">7</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">8</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">9</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<span class="n">mem_ptr</span><span class="o">[</span><span class="n">10</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="o">***</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="err">&#39;:</span><span class="w"> </span><span class="k">free</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="mh">0x0000000001d1e010</span><span class="w"> </span><span class="o">***</span><span class="w"></span>
<span class="o">=======</span><span class="w"> </span><span class="nl">Backtrace</span><span class="p">:</span><span class="w"> </span><span class="o">=========</span><span class="w"></span>
<span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="mf">.6</span><span class="p">(</span><span class="o">+</span><span class="mh">0x81429</span><span class="p">)</span><span class="o">[</span><span class="n">0x7fdf3ec46429</span><span class="o">]</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="o">[</span><span class="n">0x400524</span><span class="o">]</span><span class="w"></span>
<span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="mf">.6</span><span class="p">(</span><span class="n">__libc_start_main</span><span class="o">+</span><span class="mh">0xf5</span><span class="p">)</span><span class="o">[</span><span class="n">0x7fdf3ebe73d5</span><span class="o">]</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="o">[</span><span class="n">0x400556</span><span class="o">]</span><span class="w"></span>
<span class="o">=======</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="k">map</span><span class="err">:</span><span class="w"> </span><span class="o">========</span><span class="w"></span>
<span class="mi">00400000</span><span class="o">-</span><span class="mi">00401000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587184</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="w"></span>
<span class="mi">00600000</span><span class="o">-</span><span class="mi">00601000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587184</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="w"></span>
<span class="mi">00601000</span><span class="o">-</span><span class="mi">00602000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00001000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="mi">190587184</span><span class="w">                          </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">qtt2</span><span class="o">/</span><span class="n">ece2400</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="k">out</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">bound</span><span class="o">-</span><span class="n">access</span><span class="w"></span>
<span class="mi">01</span><span class="n">d1e000</span><span class="o">-</span><span class="mi">01</span><span class="n">d3f000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                                  </span><span class="o">[</span><span class="n">heap</span><span class="o">]</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf38000000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf38021000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf38021000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3c000000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3e9af000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3e9c4000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3e9c4000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ebc3000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">00015000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ebc3000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ebc4000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00014000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ebc4000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ebc5000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00015000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">1188523</span><span class="w">                    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libgcc_s</span><span class="o">-</span><span class="mf">4.8.5</span><span class="o">-</span><span class="mf">20150702.</span><span class="n">so</span><span class="mf">.1</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ebc5000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ed88000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ed88000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ef87000</span><span class="w"> </span><span class="o">---</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c3000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ef87000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ef8b000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c2000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ef8b000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ef8d000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">c6000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148997</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ef8d000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3ef92000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3ef92000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3efb4000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3f18b000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3f18e000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3f1b0000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3f1b3000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3f1b3000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3f1b4000</span><span class="w"> </span><span class="n">r</span><span class="o">--</span><span class="n">p</span><span class="w"> </span><span class="mi">00021000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3f1b4000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3f1b5000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00022000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">148990</span><span class="w">                     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">fdf3f1b5000</span><span class="o">-</span><span class="mi">7</span><span class="n">fdf3f1b6000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffe872bd000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffe872df000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">stack</span><span class="o">]</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffe872e7000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffe872e9000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">vdso</span><span class="o">]</span><span class="w"></span>
<span class="n">ffffffffff600000</span><span class="o">-</span><span class="n">ffffffffff601000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="o">[</span><span class="n">vsyscall</span><span class="o">]</span><span class="w"></span>
<span class="n">Aborted</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>The program crashed at the very end when it tried to free an unallocated memory block. Let's run it using valgrind:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">ECE2400: ~/ece2400/tests % valgrind --leak-check=full --error-exitcode=1 ./out-of-bound-access</span>
<span class="err">==31457== Memcheck, a memory error detector</span>
<span class="err">==31457== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.</span>
<span class="err">==31457== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info</span>
<span class="err">==31457== Command: ./out-of-bound-access</span>
<span class="err">==31457==</span>
<span class="err">Initializing mem_ptr[0] ...</span>
<span class="err">Initializing mem_ptr[1] ...</span>
<span class="err">Initializing mem_ptr[2] ...</span>
<span class="err">Initializing mem_ptr[3] ...</span>
<span class="err">Initializing mem_ptr[4] ...</span>
<span class="err">Initializing mem_ptr[5] ...</span>
<span class="err">Initializing mem_ptr[6] ...</span>
<span class="err">Initializing mem_ptr[7] ...</span>
<span class="err">Initializing mem_ptr[8] ...</span>
<span class="err">Initializing mem_ptr[9] ...</span>
<span class="err">Initializing mem_ptr[10] ...</span>
<span class="err">==31457== Invalid write of size 4</span>
<span class="err">==31457==    at 0x4004E6: main (out-of-bound-access.c:11)</span>
<span class="err">==31457==  Address 0x5202068 is 0 bytes after a block of size 40 alloc&#39;d</span>
<span class="err">==31457==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)</span>
<span class="err">==31457==    by 0x4004D1: main (out-of-bound-access.c:7)</span>
<span class="err">==31457==</span>
<span class="err">mem_ptr[0] = 0</span>
<span class="err">mem_ptr[1] = 1</span>
<span class="err">mem_ptr[2] = 2</span>
<span class="err">mem_ptr[3] = 3</span>
<span class="err">mem_ptr[4] = 4</span>
<span class="err">mem_ptr[5] = 5</span>
<span class="err">mem_ptr[6] = 6</span>
<span class="err">mem_ptr[7] = 7</span>
<span class="err">mem_ptr[8] = 8</span>
<span class="err">mem_ptr[9] = 9</span>
<span class="err">==31457== Invalid read of size 4</span>
<span class="err">==31457==    at 0x400500: main (out-of-bound-access.c:16)</span>
<span class="err">==31457==  Address 0x5202068 is 0 bytes after a block of size 40 alloc&#39;d</span>
<span class="err">==31457==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)</span>
<span class="err">==31457==    by 0x4004D1: main (out-of-bound-access.c:7)</span>
<span class="err">==31457==</span>
<span class="err">mem_ptr[10] = 10</span>
<span class="err">==31457==</span>
<span class="err">==31457== HEAP SUMMARY:</span>
<span class="err">==31457==     in use at exit: 0 bytes in 0 blocks</span>
<span class="err">==31457==   total heap usage: 1 allocs, 1 frees, 40 bytes allocated</span>
<span class="err">==31457==</span>
<span class="err">==31457== All heap blocks were freed -- no leaks are possible</span>
<span class="err">==31457==</span>
<span class="err">==31457== For counts of detected and suppressed errors, rerun with: -v</span>
<span class="err">==31457== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)</span>
</code></pre></div>
</td></tr></table>

<p>Valgrind reported an "Invalid write of size 4" in line 11 and an "Invalid read
of size 4" in line 16. They're exactly where we by mistake accessed data blocks
outside our allocated array.</p>
<p>Now, you can hopefully clearly see the bug and fix it on your own.</p>
<h2 id="how-to-use-valgrind-in-your-pas">How to use valgrind in your PAs<a class="headerlink" href="#how-to-use-valgrind-in-your-pas" title="Permanent link">&para;</a></h2>
<p>In PAs, we provide you a make target called "make memcheck" that you can use to do memory check on your tests. You can do like this</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c">% # go to your PA directory</span>
<span class="c">% cd ${HOME}/ece2400/&lt;netid&gt;/pa2-dstruct</span>
<span class="c">% mkdir -p build</span>
<span class="c">% cd build</span>
<span class="c">% # run memcheck on all tests</span>
<span class="c">% make memcheck</span>
<span class="c">% # run memcheck on a single test (e.g., dlist-basic-tests)</span>
<span class="c">% make memcheck-dlist-basic-tests</span>
<span class="c">% # see reports generated by Valgrind</span>
<span class="c">% cd memtest-logs</span>
<span class="c">% geany dlist-basic-tests.log &amp;</span>
</code></pre></div>
</td></tr></table>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Christopher Batten
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/extras.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>